using System;

namespace caTTY.Core.Types;

/// <summary>
///     A switchable screen buffer that maintains independent primary and alternate buffers.
///     Reads/writes delegate to the active buffer based on <paramref name="isAlternateActive"/>.
/// </summary>
public sealed class DualScreenBuffer : IScreenBuffer
{
    private readonly Func<bool> _isAlternateActive;
    private ScreenBuffer _primary;
    private ScreenBuffer _alternate;

    public DualScreenBuffer(int width, int height, Func<bool> isAlternateActive)
    {
        if (width <= 0) throw new ArgumentOutOfRangeException(nameof(width));
        if (height <= 0) throw new ArgumentOutOfRangeException(nameof(height));
        _isAlternateActive = isAlternateActive ?? throw new ArgumentNullException(nameof(isAlternateActive));

        _primary = new ScreenBuffer(width, height);
        _alternate = new ScreenBuffer(width, height);
    }

    public int Width => Active.Width;
    public int Height => Active.Height;

    public ScreenBuffer Primary => _primary;
    public ScreenBuffer Alternate => _alternate;

    private ScreenBuffer Active => _isAlternateActive() ? _alternate : _primary;

    public Cell GetCell(int row, int col) => Active.GetCell(row, col);

    public void SetCell(int row, int col, Cell cell) => Active.SetCell(row, col, cell);

    public void Clear() => Active.Clear();

    public void ClearRow(int row) => Active.ClearRow(row);

    public void ClearRegion(int startRow, int startCol, int endRow, int endCol) =>
        Active.ClearRegion(startRow, startCol, endRow, endCol);

    public ReadOnlySpan<Cell> GetRow(int row) => Active.GetRow(row);

    public ReadOnlyMemory<Cell> GetRowMemory(int row) => Active.GetRowMemory(row);

    public void ScrollUp(int lines) => Active.ScrollUp(lines);

    public void ScrollDown(int lines) => Active.ScrollDown(lines);

    public void CopyTo(Span<Cell> destination, int startRow, int endRow) =>
        Active.CopyTo(destination, startRow, endRow);

    public void Resize(int newWidth, int newHeight)
    {
        _primary.Resize(newWidth, newHeight);
        _alternate.Resize(newWidth, newHeight);
    }

    public bool IsInBounds(int row, int col) => Active.IsInBounds(row, col);

    public void ClearAlternate()
    {
        _alternate.Clear();
    }
}
